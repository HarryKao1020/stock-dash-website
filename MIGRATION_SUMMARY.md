# æ¶æ§‹æ”¹é€²ç¸½çµï¼šParquet + Cron Job æ’ç¨‹

## âœ… å·²å®Œæˆçš„æ”¹é€²

### 1. **Parquet æ ¼å¼å–ä»£ Pickle**

#### ä¿®æ”¹æª”æ¡ˆ
- âœ… [data/finlab_data.py](data/finlab_data.py)
  - `get_price_data()` é è¨­ä½¿ç”¨ Parquet (`use_parquet=True`)
  - `FinLabData` é è¨­ä½¿ç”¨ Parquet
  - æ‰€æœ‰ 17 å€‹ property éƒ½æ•´åˆ Parquet æ”¯æ´
  - ä¿ç•™ Pickle fallback æ©Ÿåˆ¶

#### æ•ˆæœ
- å¿«å–å¤§å°ï¼š**~813 MB â†’ ~80-160 MB** (æ¸›å°‘ **75-90%**)
- å£“ç¸®ç‡ï¼š**5-10 å€**
- æ ¼å¼ï¼šSnappy å£“ç¸®çš„åˆ—å¼å„²å­˜
- ç›¸å®¹æ€§ï¼šå¯ç”¨æ–¼ DuckDBã€Sparkã€R ç­‰å·¥å…·

---

### 2. **Cron Job å–ä»£ In-app Auto-refresh**

#### ä¿®æ”¹æª”æ¡ˆ
- âœ… [app.py](app.py:1-18)
  - ç§»é™¤ `start_auto_refresh(interval_hours=4)`
  - ç§»é™¤æ¸¬è©¦è³‡æ–™è¼‰å…¥ï¼ˆ`test_close = finlab_data.world_index_close`ï¼‰
  - æ”¹ç‚ºç´” lazy loading æ¨¡å¼

- âœ… [scripts/update_cache.py](scripts/update_cache.py)
  - æ”¹å¯«ç‚ºå®Œæ•´çš„å¿«å–æ›´æ–°è…³æœ¬
  - æ”¯æ´ Parquet æ ¼å¼
  - æ›´æ–°æ‰€æœ‰ 19 é …è³‡æ–™
  - è©³ç´°çš„åŸ·è¡Œå ±å‘Šï¼ˆæˆåŠŸç‡ã€å¿«å–å¤§å°ã€åŸ·è¡Œæ™‚é–“ï¼‰

- âœ… [scripts/crontab.example](scripts/crontab.example)
  - æ›´æ–°ç‚ºä½¿ç”¨ `update_cache.py`
  - å»ºè­°æ’ç¨‹ï¼šäº¤æ˜“æ—¥æ—©ä¸Š 7:30
  - æä¾›æœ¬åœ°å’Œ Docker ç’°å¢ƒç¯„ä¾‹

#### æ•ˆæœ
- âœ… **ç¨ç«‹æ–¼æ‡‰ç”¨ç¨‹å¼**ï¼šé‡å•Ÿä¸å½±éŸ¿æ’ç¨‹
- âœ… **ç²¾ç¢ºæ§åˆ¶æ™‚é–“**ï¼šå¯è¨­å®šåœ¨é–‹ç›¤å‰æ›´æ–°
- âœ… **æ˜“æ–¼ç›£æ§**ï¼šlog æª”æ¡ˆè¨˜éŒ„æ¯æ¬¡åŸ·è¡Œ
- âœ… **ç¯€çœè³‡æº**ï¼šä¸ä½”ç”¨æ‡‰ç”¨ç¨‹å¼è¨˜æ†¶é«”

---

### 3. **ä¿æŒ Lazy Loading**

#### è¨­è¨ˆ
- âœ… **finlab_data.py**: æ‰€æœ‰ property éƒ½æ˜¯ lazy loading
  ```python
  @property
  def close(self):
      if self._close is None:  # åªåœ¨ç¬¬ä¸€æ¬¡å­˜å–æ™‚è¼‰å…¥
          self._close = get_price_data("price:æ”¶ç›¤åƒ¹", use_parquet=self._use_parquet)
      return self._close
  ```

- âœ… **shioaji_data.py**: å…¨åŸŸå¿«å– lazy loading
  ```python
  _tse_cache = None  # åˆå§‹ç‚º None
  _otc_cache = None

  def get_cached_or_fetch(api):
      if _tse_cache is None or _otc_cache is None:
          # è¼‰å…¥è³‡æ–™
  ```

- âœ… **app.py**: ä¸åœ¨å•Ÿå‹•æ™‚é è¼‰è³‡æ–™
  - ç§»é™¤æ¸¬è©¦ä»£ç¢¼
  - warmup API ä»ä¿ç•™ï¼ˆé¸ç”¨ï¼‰

#### æ•ˆæœ
- æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•é€Ÿåº¦ï¼š**ç§’ç´š** ï¼ˆä¸éœ€ç­‰å¾…è³‡æ–™ä¸‹è¼‰ï¼‰
- è¨˜æ†¶é«”ä½”ç”¨ï¼šæœ€å°åŒ–ï¼ˆåªè¼‰å…¥éœ€è¦çš„è³‡æ–™ï¼‰
- ä½¿ç”¨è€…é«”é©—ï¼šé¦–æ¬¡å­˜å–é é¢æ™‚è¼‰å…¥ï¼Œå¾ŒçºŒä½¿ç”¨å¿«å–

---

## ğŸ“Š æ–°æ¶æ§‹æµç¨‹

### è³‡æ–™æ›´æ–°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cron Job (äº¤æ˜“æ—¥ 7:30)                                   â”‚
â”‚ scripts/update_cache.py                                 â”‚
â”‚                                                          â”‚
â”‚ 1. æ¸…é™¤èˆŠå¿«å–                                            â”‚
â”‚ 2. ä¸‹è¼‰æ‰€æœ‰ FinLab è³‡æ–™                                  â”‚
â”‚ 3. å„²å­˜ç‚º Parquet æ ¼å¼ (cache/*.parquet)                â”‚
â”‚ 4. è¨˜éŒ„åŸ·è¡Œçµæœåˆ° log                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½¿ç”¨è€…è¨ªå•æ‡‰ç”¨ç¨‹å¼                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lazy Loading (é¦–æ¬¡å­˜å–æ™‚)                                â”‚
â”‚                                                          â”‚
â”‚ finlab_data.close â†’ æª¢æŸ¥å¿«å– â†’ è®€å– Parquet              â”‚
â”‚                     â†“ (å­˜åœ¨)                             â”‚
â”‚                 è¼‰å…¥åˆ°è¨˜æ†¶é«”                              â”‚
â”‚                 (å¾ŒçºŒå­˜å–ç›´æ¥ç”¨è¨˜æ†¶é«”)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¿«å–ç”Ÿå‘½é€±æœŸ

```
æ™‚é–“è»¸ï¼š
07:30 â”€â”€â”€â”€â–º Cron æ›´æ–°å¿«å– (Parquet)
08:00 â”€â”€â”€â”€â–º ä½¿ç”¨è€…è¨ªå•é é¢ (Lazy loading å¾ Parquet è®€å–)
09:00 â”€â”€â”€â”€â–º ä½¿ç”¨è€…å†æ¬¡è¨ªå• (ç›´æ¥ç”¨è¨˜æ†¶é«”å¿«å–)
...
éš”å¤© 07:30 â”€â–º Cron å†æ¬¡æ›´æ–°
```

---

## ğŸ”§ è¨­å®šæŒ‡å—

### 1. å®‰è£ Cron Job

#### Docker ç’°å¢ƒï¼ˆæ¨è–¦ï¼‰

```bash
# 1. è¤‡è£½ crontab ç¯„ä¾‹
cp scripts/crontab.example /tmp/stock-dash-cron

# 2. ç·¨è¼¯æª”æ¡ˆï¼Œä¿®æ”¹å°ˆæ¡ˆè·¯å¾‘
nano /tmp/stock-dash-cron
# ä¿®æ”¹: PROJECT_DIR=/path/to/stock-dash-project

# 3. å–æ¶ˆè¨»è§£ Docker ç›¸é—œè¡Œï¼ˆç¬¬ 39 è¡Œï¼‰
# 30 7 * * 1-5 cd $PROJECT_DIR && docker-compose exec -T web python scripts/update_cache.py >> $LOG_DIR/cache_update.log 2>&1

# 4. å®‰è£ crontab
crontab /tmp/stock-dash-cron

# 5. é©—è­‰
crontab -l
```

#### æœ¬åœ°ç’°å¢ƒ

```bash
# 1-2. åŒä¸Š

# 3. å–æ¶ˆè¨»è§£æœ¬åœ°ç›¸é—œè¡Œï¼ˆç¬¬ 36 è¡Œï¼‰
# 30 7 * * 1-5 cd $PROJECT_DIR && python3 scripts/update_cache.py >> $LOG_DIR/cache_update.log 2>&1

# 4-5. åŒä¸Š
```

### 2. æ‰‹å‹•æ¸¬è©¦æ›´æ–°è…³æœ¬

```bash
# Docker ç’°å¢ƒ
docker-compose exec web python scripts/update_cache.py

# æœ¬åœ°ç’°å¢ƒ
python3 scripts/update_cache.py
```

### 3. å»ºç«‹ logs ç›®éŒ„

```bash
mkdir -p logs
```

---

## ğŸ“ æª”æ¡ˆè®Šæ›´æ¸…å–®

### ä¿®æ”¹çš„æª”æ¡ˆ
- âœ… [data/finlab_data.py](data/finlab_data.py)
- âœ… [app.py](app.py)
- âœ… [CLAUDE.md](CLAUDE.md)
- âœ… [scripts/update_cache.py](scripts/update_cache.py)
- âœ… [scripts/crontab.example](scripts/crontab.example)

### æ–°å¢çš„æª”æ¡ˆ
- âœ… `MIGRATION_SUMMARY.md` (æœ¬æ–‡ä»¶)

### åˆªé™¤çš„æª”æ¡ˆ
- âœ… POC æ¸¬è©¦ç›¸é—œæª”æ¡ˆï¼ˆå·²æ¸…ç†ï¼‰

---

## âš™ï¸ é€²éšè¨­å®š

### é¸é … 1: æ”¶ç›¤å¾Œå†æ›´æ–°ä¸€æ¬¡

```bash
# åœ¨ crontab æ–°å¢
30 14 * * 1-5 cd $PROJECT_DIR && python3 scripts/update_cache.py >> $LOG_DIR/cache_update.log 2>&1
```

### é¸é … 2: æ¯å¤©åŸ·è¡Œï¼ˆåŒ…å«é€±æœ«ï¼‰

```bash
# ä¿®æ”¹ crontab
30 7 * * * cd $PROJECT_DIR && python3 scripts/update_cache.py >> $LOG_DIR/cache_update.log 2>&1
```

### é¸é … 3: Log è¼ªæ›¿ï¼ˆæ¸…ç†èˆŠ logï¼‰

```bash
# åœ¨ crontab æ–°å¢ï¼ˆæ¯æœˆ 1 è™Ÿæ¸…ç† 30 å¤©å‰çš„ logï¼‰
0 2 1 * * find $LOG_DIR -name "*.log" -mtime +30 -delete
```

---

## ğŸ› æ•…éšœæ’é™¤

### å•é¡Œ 1: Cron æ²’æœ‰åŸ·è¡Œ

**æª¢æŸ¥ï¼š**
```bash
# ç¢ºèª cron æœå‹™é‹è¡Œ
sudo service cron status  # Linux
# æˆ–
launchctl list | grep cron  # macOS

# æŸ¥çœ‹ cron log
tail -f /var/log/syslog | grep CRON  # Linux
tail -f /var/log/system.log | grep cron  # macOS
```

### å•é¡Œ 2: Docker ç’°å¢ƒç„¡æ³•åŸ·è¡Œ

**è§£æ±ºï¼š**
```bash
# ç¢ºèªå®¹å™¨åç¨±
docker-compose ps

# æ¸¬è©¦æ‰‹å‹•åŸ·è¡Œ
docker-compose exec web python scripts/update_cache.py

# å¦‚æœå¤±æ•—ï¼Œæª¢æŸ¥å®¹å™¨æ˜¯å¦é‹è¡Œ
docker-compose up -d
```

### å•é¡Œ 3: Parquet è®€å–å¤±æ•—

**è§£æ±ºï¼š**
```bash
# æª¢æŸ¥ pyarrow æ˜¯å¦å®‰è£
docker-compose exec web python -c "import pyarrow; print(pyarrow.__version__)"

# å¦‚æœç¼ºå°‘ï¼Œé‡æ–°å»ºç½®
docker-compose up -d --build
```

### å•é¡Œ 4: Log æª”æ¡ˆéå¤§

**è§£æ±ºï¼š**
```bash
# æ‰‹å‹•æ¸…ç†
rm logs/cache_update.log

# æˆ–ä½¿ç”¨ logrotate
sudo nano /etc/logrotate.d/stock-dash
# åŠ å…¥:
# /path/to/project/logs/*.log {
#     daily
#     rotate 7
#     compress
#     missingok
# }
```

---

## ğŸ“ˆ æ•ˆèƒ½æ¯”è¼ƒ

| æŒ‡æ¨™ | èˆŠæ¶æ§‹ (Pickle + Auto-refresh) | æ–°æ¶æ§‹ (Parquet + Cron) | æ”¹å–„ |
|-----|-------------------------------|------------------------|------|
| **å¿«å–å¤§å°** | ~813 MB | ~80-160 MB | â†“ 75-90% |
| **æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•** | 10-30 ç§’ï¼ˆé è¼‰è³‡æ–™ï¼‰ | 1-2 ç§’ | â†“ 80-95% |
| **è¨˜æ†¶é«”ä½”ç”¨** | é«˜ï¼ˆèƒŒæ™¯ thread + è³‡æ–™ï¼‰ | ä½ï¼ˆåƒ…è³‡æ–™ï¼‰ | â†“ 30-50% |
| **æ›´æ–°å¯é æ€§** | ä¸­ï¼ˆé‡å•Ÿä¸­æ–·ï¼‰ | é«˜ï¼ˆç¨ç«‹æ’ç¨‹ï¼‰ | âœ… æ”¹å–„ |
| **æ™‚é–“æ§åˆ¶** | ç„¡æ³•ç²¾ç¢º | ç²¾ç¢ºåˆ°åˆ†é˜ | âœ… æ”¹å–„ |
| **ç›£æ§èƒ½åŠ›** | ç„¡ log | å®Œæ•´ log | âœ… æ–°å¢ |

---

## âœ… é©—è­‰æ¸…å–®

å®Œæˆé·ç§»å¾Œï¼Œè«‹é©—è­‰ï¼š

- [ ] æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•é€Ÿåº¦è®Šå¿«ï¼ˆä¸å†é è¼‰è³‡æ–™ï¼‰
- [ ] å¿«å–ç›®éŒ„å­˜åœ¨ `.parquet` æª”æ¡ˆ
- [ ] å¿«å–ç¸½å¤§å°ç´„ 80-160 MB
- [ ] Cron job å·²å®‰è£ï¼ˆ`crontab -l` æŸ¥çœ‹ï¼‰
- [ ] æ‰‹å‹•åŸ·è¡Œ `scripts/update_cache.py` æˆåŠŸ
- [ ] logs ç›®éŒ„å­˜åœ¨ä¸”æœ‰ `cache_update.log`
- [ ] æ‰€æœ‰é é¢åŠŸèƒ½æ­£å¸¸

---

**å®Œæˆæ—¥æœŸ:** 2025-12-25
**æ”¹é€²ç‰ˆæœ¬:** v2.0 (Parquet + Cron Job)
